---
id: wiki-us-bridgechain
title: 跨链转接桥网络
sidebar_label: 跨链转接桥网络
---

达尔文桥接链是达尔文网络中最重要的部分，也是各个应用子链和公链的桥接枢纽。

达尔文网络自身可以作为一个独立的跨链网络运行，达尔文链将负责共识安全和跨链互操作。同时，得益于 Polkadot 提供了一套开放的平行链接入方式，达尔文链也可以选择接入 Polkadot 作为平行链运行，Polkadot 将接管并负责达尔文链的安全，这样，达尔文网络中的所有应用链将可以通过 Polkadot 连接至外部更广泛的区块链网络。

达尔文的跨链转接桥协议采用的是 CBA(Cryptocurrency-backed Assets) 的模型，底层使用 chain relay 证明交易的存在性以及区块共识。

## I. CBA模型

用户将资产从一条链转移至另一条链，需要将源链上的资产(称之为原生资产)作为抵押物锁仓至跨链桥的属于源链的桥头端，以此为背书，在跨链桥的另一个桥头端目标链上发行相应的资产（称之为映射资产）。

#### CBA 模型的几个要素
- 原生资产 源链上的用户资产；
- 映射资产 目标链上发行的以原生资产为抵押物的资产；
- Backing 源链端用于抵押、保存和赎回用户原生资产的模块；
- Issuing 目标链端用于发行、销毁用户映射资产的模块；
- 资产owner 拥有原生资产或者映射资产的账户。

#### 达尔文转接桥关于CBA模型的使用
以 Ethereum 到 Darwinia 链为例，Ethereum 上的资产就属于原生资产，转接桥会在 Ethereum 网络上创建 backing 合约，并在 Darwinia 网络上创建 issuing 模块，当用户需要转移资产时，向 backing 合约发出交易请求，并指定资产类型、数量以及接收账号，该交易会将用户资产发送至 backing 合约锁定。之后 issuing 模块发行对应的映射资产以及对应的数量到接收账号. 当用户需要赎回资产时，向issuing模块发送赎回请求并指定接收账号，issuing 模块销毁映射资产，之后 backing 模块解锁原生资产给接收账户。

整个过程需要做到去中心化，没有任何第三方背书，达尔文使用的是 *chain relay* 技术。

## II. chain relay

backing 和 issuing 分别在不同的链上，issuing 模块对于映射资产的发行需要知道并获取 backing 上的资产锁定证明，同样 backing 模块对于原生资产的赎回操作也需要获取 issuing 上的资产销毁证明. 而这些证明的提交和校验不依赖第三方. chain relay 的意义是在向目标链通过去中心化的方式提交源链上可信的交易以及区块。
- 交易存在性证明: 交易存在于区块，每一笔交易存在唯一的交易 hash，并且一个区块的所有交易产生一个 merkle tree 的 root 存储在区块头中，因此 chain relay 提交区块头以及交易的 merkle 证明就可以证明该交易存在于某个区块中；
- 区块证明(共识证明): 跟 merkle tree 类似的，所有的区块也可以构成一个称之为 mmr(merkle mountain range) 的数据结构，chain relay 提供区块的 merkle 证明以及 mmr root 便可以证明区块的存在性，前提是这个 root 也是被证明的；
- mmr root 证明: chain relay 允许任何用户(relayer)向目标链上提交 mmr root。 并在该 mmr root 被确认之前设定一个挑战的时长，这里会有一个抵押、惩罚和奖励的机制用于激励 relayer 提交真实的 root，错误的 mmr root 会被后来的 relayer 挑战，理论上当挑战轮次足够多的时候一定是提交真实 root 的 relayer 会获胜，但实际上不会有太多的挑战轮次，因为惩罚的机制会促使 relayer 不会使用错误的 root 反复发起挑战。

chain relay 保证了 issuing 模块接收来自 backing 的资产锁定证明的真实可靠，同时反向的 chain relay 保证了 backing 接收 issuing 的资产销毁赎回证明的真实性。达尔文桥在 backing 和 issuing 模块上加入对方链的一个超轻客户端，底层依赖 chain relay 完成链基本数据之间的同步。之所以我们称之为超轻客户端，是因为相对于请客户端，其只需要同步非常少的数据，就能够保证对对方数据真实性。这对于节省网络开销和费用是非常有利的。

当前达尔文转接桥对于以太坊到达尔文的chain relay完整的采用的上述机制。而达尔文到以太坊的转接桥，考虑到 gas 费用问题，目前块头的正确性使用的是由达尔文到以太坊 Authorities 多签来保证。未来，当以太坊支持 ed25519 的预编译指令后，块头的正确性可以由达尔文 Granpa Authorities 来保证。

桥矿工（relayer）
桥矿工的角色是将一条链上的 relay 证明提交至另一条链，矿工之间互相监督，提交正确的数据可获得奖励，错误的数据可能被惩罚，由于链可能存在分叉场景，因此桥矿工也可能无意间提交错误数据，为避免此类场景，矿工们可以尽可能提交规范链上的被确认的区块。当然这对整个转接桥的安全性没有影响，因为分叉链是不可持续的，一旦当某个矿工发现了这种分叉存在，会立刻发起挑战并纠正过来。

## III. 转接桥注册协议（ERC20）
![架构图](assets/bridger-register.svg)

任何其他网络的资产到达达尔文网络成为映射资产后，其名称保持不变，Symbol 会在之前加一个 m 标识符表示映射级别。精度保持不变。

#### 资产注册
- 用户调用 Ethereum 端的 Backing 合约接口，发起桥接注册，要求注册的 Token 必须符合 ERC20 标准，同时几个可选参数 name, symbol, decimal 变为必选。
- 注册产生注册事件，桥矿工收到注册事件之后，向 shadow 服务（提供实时计算 Ethereum 区块的 mmr root 的服务）请求 mmr root，该 mmr root 所在区块高度比注册交易所在区块要高，通常取高出一个区块。桥矿工将 mmr root 提交至达尔文网络，等待网络确认。该确认不仅是交易的确认，而且还是 relay 的过程的最终的确认。
- 当 mmr root 被达尔文网络确认后，提交注册交易所在区块以及交易的证明至达尔文网络。
- 达尔文网络的 issuing 模块收到该证明后校验交易并解析事件，获取映射资产创建所需信息，主要包括 Token 的原生地址，name, symbol, decimal 信息。
- issuing 调用 dvm 创建映射资产合约，并产生创建事件证明，触发 authorities 对事件所在区块的 mmr root 签名。
- 此时用户可以将签名信息和交易证明打包发送至 backing 模块，完成注册流程。

#### 资产跨链
- 用户调用 backing 合约接口，请求跨链转账，完成资产锁定并产生锁定事件证明。
- 同注册流程，桥矿工将该事件证明 relay 到达尔文端的 issuing 模块。
- issuing 模块验证交易并解析事件信息，调用 dvm 发行映射资产到指定账户。

#### 资产赎回
- 用户调用 issuing 端的合约接口，发起赎回请求，issuing 端销毁映射资产并产生销毁证明。
- 销毁过程触发 authorities 对区块的 mmr root 签名。
- 用户将该 mmr root 签名和资产销毁证明打包发送至 backing 模块，赎回资产。

#### 手续费
为激励桥矿工的稳定存在而保证桥的稳定工作，会在用户发起注册和转账的过程中收取少量手续费用于支付桥矿工费用。资产注册的时候使用 KTON 作为支付 token，转账使用 RING 作为支付 token，桥在工作的同时将费用一并转移至达尔文网络，由手续费模块以及清算系统统一管理。

#### 开发者
桥接工作由链上合约，虫洞，bridger配合完成，虫洞是直接和链上合约对接的工具，用于发起注册，确认注册，发起转账以及赎回资产。尽管虫洞不保存任何用户资产，但其仍然是一个中心化的服务，用户或者开发者还可以通过配合钱包的合约调用以及 bridger 等工具完成整个桥的转账和资产赎回过程。
- 资产注册接口
- 资产转账接口
- bridger 获取资产注册信息以及资产赎回证明接口
- 资产赎回接口
